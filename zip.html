<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>ZIPæ–‡ä»¶è§£å‹ç¤ºä¾‹</title>
    <style>
        body { max-width: 800px; margin: 20px auto; padding: 20px; }
        #fileList { margin-top: 20px; border: 1px solid #ccc; padding: 10px; }
        .file-item { margin: 5px 0; padding: 5px; border-bottom: 1px solid #eee; }
        img.preview { max-width: 300px; margin-top: 10px; display: block; }
        .error { color: red; }
        .success { color: green; }
        .input-group { margin: 15px 0; }
        input[type="text"] { width: 70%; padding: 8px; }
        button { padding: 8px 15px; cursor: pointer; background-color: #4CAF50; color: white; border: none; }
        button:hover { background-color: #45a049; }
        .progress-container { margin-top: 10px; width: 100%; background-color: #f1f1f1; }
        .progress-bar { height: 20px; background-color: #4CAF50; width: 0%; }
    </style>
</head>
<body>
    <h1>ZIPæ–‡ä»¶è§£å‹æ¼”ç¤º</h1>
    <div class="input-group">
        <input type="text" id="zipUrl" placeholder="è¾“å…¥ZIPæ–‡ä»¶URLï¼Œä¾‹å¦‚ï¼šhttps://example.com/file.zip" />
        <button id="downloadBtn">ä¸‹è½½å¹¶è§£å‹</button>
    </div>
    
    <div class="input-group">
        <p>æˆ–è€…ä»æœ¬åœ°ä¸Šä¼ ï¼š</p>
        <input type="file" id="zipFile" accept=".zip" />
    </div>
    
    <div id="status"></div>
    <div class="progress-container" id="progressContainer" style="display: none;">
        <div class="progress-bar" id="progressBar"></div>
    </div>
    <div id="fileList"></div>
    
    <hr style="margin: 30px 0;">
    <h2>åº”ç”¨å†…æ–‡æ¡£æµè§ˆ</h2>
    <div class="input-group">
        <button id="browseDocBtn">æµè§ˆåº”ç”¨å†…docæ–‡ä»¶å¤¹</button>
    </div>
    <div id="docStatus" class="status"></div>
    <div id="docFileList" style="margin-top: 20px; border: 1px solid #ccc; padding: 10px;"></div>
    <div id="filePreview" style="margin-top: 20px; display: none;">
        <h3 id="previewTitle"></h3>
        <div id="previewContent"></div>
        <button id="closePreviewBtn" style="margin-top: 10px;">å…³é—­é¢„è§ˆ</button>
    </div>

    <script>
    if(window.plus) {
        plusReady();
    } else {
        document.addEventListener("plusready", plusReady, false);
    }

    function plusReady() {
        // æ£€æŸ¥å¹¶åˆ›å»ºzipinæ–‡ä»¶å¤¹
        plus.io.resolveLocalFileSystemURL('_doc/zipin/', (entry) => {
            console.log('zipinæ–‡ä»¶å¤¹å·²å­˜åœ¨');
            // è¯»å–æ–‡ä»¶å¤¹å†…å®¹
            const directoryReader = entry.createReader();
            directoryReader.readEntries((entries) => {
                console.log(`zipinæ–‡ä»¶å¤¹ä¸­æœ‰ ${entries.length} ä¸ªæ–‡ä»¶/æ–‡ä»¶å¤¹`);
            }, (error) => {
                console.error('è¯»å–zipinæ–‡ä»¶å¤¹å¤±è´¥:', error);
            });
        }, (error) => {
            // æ–‡ä»¶å¤¹ä¸å­˜åœ¨ï¼Œåˆ›å»ºå®ƒ
            plus.io.resolveLocalFileSystemURL('_doc/', (root) => {
                root.getDirectory('zipin', { create: true }, (dirEntry) => {
                    console.log('zipinæ–‡ä»¶å¤¹åˆ›å»ºæˆåŠŸ');
                }, (error) => {
                    console.error('åˆ›å»ºzipinæ–‡ä»¶å¤¹å¤±è´¥:', error);
                });
            }, (error) => {
                console.error('è®¿é—®_docç›®å½•å¤±è´¥:', error);
            });
        });

        // æ£€æŸ¥å¹¶åˆ›å»ºhuiyiæ–‡ä»¶å¤¹
        plus.io.resolveLocalFileSystemURL('_doc/huiyi/', (entry) => {
            console.log('huiyiæ–‡ä»¶å¤¹å·²å­˜åœ¨');
            // è¯»å–æ–‡ä»¶å¤¹å†…å®¹
            const directoryReader = entry.createReader();
            directoryReader.readEntries((entries) => {
                console.log(`huiyiæ–‡ä»¶å¤¹ä¸­æœ‰ ${entries.length} ä¸ªæ–‡ä»¶/æ–‡ä»¶å¤¹`);
            }, (error) => {
                console.error('è¯»å–huiyiæ–‡ä»¶å¤¹å¤±è´¥:', error);
            });
        }, (error) => {
            // æ–‡ä»¶å¤¹ä¸å­˜åœ¨ï¼Œåˆ›å»ºå®ƒ
            plus.io.resolveLocalFileSystemURL('_doc/', (root) => {
                root.getDirectory('huiyi', { create: true }, (dirEntry) => {
                    console.log('huiyiæ–‡ä»¶å¤¹åˆ›å»ºæˆåŠŸ');
                }, (error) => {
                    console.error('åˆ›å»ºhuiyiæ–‡ä»¶å¤¹å¤±è´¥:', error);
                });
            }, (error) => {
                console.error('è®¿é—®_docç›®å½•å¤±è´¥:', error);
            });
        });

        const zipFileInput = document.getElementById('zipFile');
        const zipUrlInput = document.getElementById('zipUrl');
        const downloadBtn = document.getElementById('downloadBtn');
        const fileListDiv = document.getElementById('fileList');
        const statusDiv = document.getElementById('status');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');

        // è®¾ç½®é»˜è®¤URL
        const defaultZipUrl = 'http://123.56.40.178/data.zip';
        zipUrlInput.value = defaultZipUrl;

        // ç½‘ç»œä¸‹è½½ZIPæ–‡ä»¶åŠŸèƒ½
        downloadBtn.addEventListener('click', async () => {
            const url = zipUrlInput.value.trim() || defaultZipUrl;
            if (!url) {
                statusDiv.textContent = 'è¯·è¾“å…¥æœ‰æ•ˆçš„ZIPæ–‡ä»¶URL';
                statusDiv.className = 'error';
                return;
            }

            statusDiv.textContent = 'æ­£åœ¨ä¸‹è½½...';
            statusDiv.className = '';
            fileListDiv.innerHTML = '';
            progressContainer.style.display = 'block';
            progressBar.style.width = '0%';

            try {
                // ä»URLä¸­è·å–æ–‡ä»¶å
                const fileName = url.split('/').pop() || 'data.zip';
                const targetPath = '_doc/zipin/' + fileName;
                
                // å…ˆæ£€æŸ¥æ˜¯å¦å­˜åœ¨åŒåæ–‡ä»¶
                plus.io.resolveLocalFileSystemURL(targetPath, (entry) => {
                    // å¦‚æœæ–‡ä»¶å­˜åœ¨ï¼Œå…ˆåˆ é™¤å®ƒ
                    entry.remove(() => {
                        console.log(`å·²åˆ é™¤æ—§çš„${fileName}æ–‡ä»¶`);
                        startDownload(targetPath);
                    }, (error) => {
                        console.error('åˆ é™¤æ—§æ–‡ä»¶å¤±è´¥:', error);
                        startDownload(targetPath);
                    });
                }, (error) => {
                    // æ–‡ä»¶ä¸å­˜åœ¨ï¼Œç›´æ¥å¼€å§‹ä¸‹è½½
                    startDownload(targetPath);
                });

                function startDownload(targetPath) {
                    const dtask = plus.downloader.createDownload(url, {
                        filename: targetPath
                    }, function(d, status) {
                        console.log('ä¸‹è½½å®ŒæˆçŠ¶æ€:', status, 'ä¸‹è½½ä»»åŠ¡ä¿¡æ¯:', d);
                        // æ£€æŸ¥ä¸‹è½½çŠ¶æ€ï¼ŒHTTPçŠ¶æ€ç 2xxè¡¨ç¤ºæˆåŠŸ
                        if (status >= 200 && status < 300) {
                            statusDiv.textContent = 'ä¸‹è½½å®Œæˆï¼Œæ­£åœ¨è§£å‹...';
                            statusDiv.className = '';
                            // è‡ªåŠ¨è§£å‹åˆ°huiyiæ–‡ä»¶å¤¹
                            plus.zip.decompress(targetPath, '_doc/huiyi/', (success) => {
                                statusDiv.textContent = 'è§£å‹å®Œæˆ';
                                statusDiv.className = 'success';
                                progressContainer.style.display = 'none';
                            }, (error) => {
                                console.error('è§£å‹å¤±è´¥:', error);
                                statusDiv.textContent = `è§£å‹å¤±è´¥: ${error.message}`;
                                statusDiv.className = 'error';
                                progressContainer.style.display = 'none';
                            });
                        } else if (status === 404) {
                            console.error('æ–‡ä»¶ä¸å­˜åœ¨ï¼ŒçŠ¶æ€ç :', status);
                            statusDiv.textContent = 'ä¸‹è½½å¤±è´¥: æ–‡ä»¶ä¸å­˜åœ¨';
                            statusDiv.className = 'error';
                            progressContainer.style.display = 'none';
                        } else {
                            console.error('ä¸‹è½½å¤±è´¥ï¼ŒçŠ¶æ€ç :', status);
                            statusDiv.textContent = 'ä¸‹è½½å¤±è´¥: ç½‘ç»œé”™è¯¯';
                            statusDiv.className = 'error';
                            progressContainer.style.display = 'none';
                        }
                    });
                
                    dtask.addEventListener("statechanged", function(task, status) {
                        switch(task.state) {
                            case 1: // å¼€å§‹
                                console.log("å¼€å§‹ä¸‹è½½");
                                break;
                            case 2: // å·²è¿æ¥åˆ°æœåŠ¡å™¨
                                console.log("å·²è¿æ¥åˆ°æœåŠ¡å™¨");
                                break;
                            case 3: // ä¸‹è½½ä¸­
                                if (task.totalSize > 0) {
                                    const progress = (task.downloadedSize / task.totalSize) * 100;
                                    progressBar.style.width = `${Math.round(progress)}%`;
                                    statusDiv.textContent = `ä¸‹è½½è¿›åº¦: ${Math.round(progress)}%`;
                                }
                                break;
                            case 4: // ä¸‹è½½å¤±è´¥
                                console.error("ä¸‹è½½å¤±è´¥ï¼Œé”™è¯¯ä¿¡æ¯:", task.filename, task.downloadedSize, task.totalSize);
                                statusDiv.textContent = `ä¸‹è½½å¤±è´¥: ${task.state}`;
                                statusDiv.className = 'error';
                                progressContainer.style.display = 'none';
                                break;
                        }
                    });
                
                    dtask.start();
                }
            } catch (err) {
                statusDiv.textContent = `ä¸‹è½½å¤±è´¥: ${err.message}`;
                statusDiv.className = 'error';
                progressContainer.style.display = 'none';
            }
        });

        // æœ¬åœ°æ–‡ä»¶å¤„ç†
        zipFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const MAX_SIZE = 100 * 1024 * 1024;
            if (file.size > MAX_SIZE) {
                statusDiv.textContent = 'æ–‡ä»¶è¿‡å¤§ï¼Œè¯·é€‰æ‹©100MBä»¥ä¸‹çš„ZIPæ–‡ä»¶';
                statusDiv.className = 'error';
                return;
            }

            statusDiv.textContent = 'å‡†å¤‡è§£å‹...';
            statusDiv.className = '';
            fileListDiv.innerHTML = '';
            
            // è·å–æœ¬åœ°æ–‡ä»¶è·¯å¾„
            const fileURL = plus.io.convertLocalFileSystemURL(file.path);
            decompressFile(fileURL);
        });

        // è§£å‹æ–‡ä»¶
        function decompressFile(zipPath) {
            const targetPath = '_doc/unzip/';
            
            plus.zip.decompress(zipPath, targetPath, (success) => {
                statusDiv.textContent = 'è§£å‹å®Œæˆ';
                statusDiv.className = 'success';
                progressContainer.style.display = 'none';
                
                // åˆ—å‡ºè§£å‹åçš„æ–‡ä»¶
                plus.io.resolveLocalFileSystemURL(targetPath, (entry) => {
                    const directoryReader = entry.createReader();
                    directoryReader.readEntries((entries) => {
                        entries.forEach((fileEntry) => {
                            if (!fileEntry.isDirectory) {
                                const fileItem = document.createElement('div');
                                fileItem.className = 'file-item';
                                
                                fileItem.innerHTML = `
                                    <div><strong>æ–‡ä»¶åï¼š</strong>${fileEntry.name}</div>
                                `;

                                // å¤„ç†å›¾ç‰‡é¢„è§ˆ
                                if (/\.(png|jpe?g|gif|webp)$/i.test(fileEntry.name)) {
                                    const img = document.createElement('img');
                                    img.className = 'preview';
                                    img.src = fileEntry.toLocalURL();
                                    fileItem.appendChild(img);
                                }

                                // å¤„ç†æ–‡æœ¬æ–‡ä»¶
                                if (/\.(txt|html?|css|js|json|xml)$/i.test(fileEntry.name)) {
                                    fileEntry.file((file) => {
                                        const reader = new plus.io.FileReader();
                                        reader.onloadend = function(evt) {
                                            const pre = document.createElement('pre');
                                            pre.textContent = evt.target.result;
                                            fileItem.appendChild(pre);
                                        };
                                        reader.readAsText(file);
                                    });
                                }

                                fileListDiv.appendChild(fileItem);
                            }
                        });
                    });
                });
            }, (error) => {
                statusDiv.textContent = `è§£å‹å¤±è´¥: ${error.message}`;
                statusDiv.className = 'error';
                progressContainer.style.display = 'none';
            });
        }
        
        // åº”ç”¨å†…æ–‡æ¡£æµè§ˆåŠŸèƒ½
        const browseDocBtn = document.getElementById('browseDocBtn');
        const docStatusDiv = document.getElementById('docStatus');
        const docFileListDiv = document.getElementById('docFileList');
        const filePreviewDiv = document.getElementById('filePreview');
        const previewTitleDiv = document.getElementById('previewTitle');
        const previewContentDiv = document.getElementById('previewContent');
        const closePreviewBtn = document.getElementById('closePreviewBtn');
        
        // å½“å‰æµè§ˆçš„è·¯å¾„
        let currentPath = '_doc/';
        let pathHistory = [];
        
        // æµè§ˆæ–‡æ¡£æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        browseDocBtn.addEventListener('click', () => {
            browseDocFolder(currentPath);
        });
        
        // å…³é—­é¢„è§ˆæŒ‰é’®ç‚¹å‡»äº‹ä»¶
        closePreviewBtn.addEventListener('click', () => {
            filePreviewDiv.style.display = 'none';
        });
        
        // æµè§ˆæ–‡æ¡£æ–‡ä»¶å¤¹
        function browseDocFolder(path) {
            docStatusDiv.textContent = 'æ­£åœ¨åŠ è½½æ–‡ä»¶...';
            docStatusDiv.className = '';
            docFileListDiv.innerHTML = '';
            
            // æ·»åŠ è¿”å›ä¸Šçº§ç›®å½•æŒ‰é’®ï¼ˆå¦‚æœä¸æ˜¯æ ¹ç›®å½•ï¼‰
            if (pathHistory.length > 0) {
                const backBtn = document.createElement('button');
                backBtn.textContent = 'è¿”å›ä¸Šçº§ç›®å½•';
                backBtn.style.marginBottom = '10px';
                backBtn.addEventListener('click', () => {
                    currentPath = pathHistory.pop();
                    browseDocFolder(currentPath);
                });
                docFileListDiv.appendChild(backBtn);
                docFileListDiv.appendChild(document.createElement('hr'));
            }
            
            // æ˜¾ç¤ºå½“å‰è·¯å¾„
            const pathDiv = document.createElement('div');
            pathDiv.innerHTML = `<strong>å½“å‰è·¯å¾„ï¼š</strong>${path}`;
            pathDiv.style.marginBottom = '10px';
            docFileListDiv.appendChild(pathDiv);
            
            try {
                plus.io.resolveLocalFileSystemURL(path, (entry) => {
                    const directoryReader = entry.createReader();
                    directoryReader.readEntries((entries) => {
                        if (entries.length === 0) {
                            docStatusDiv.textContent = 'æ–‡ä»¶å¤¹ä¸ºç©º';
                            return;
                        }
                        
                        docStatusDiv.textContent = `æ‰¾åˆ° ${entries.length} ä¸ªæ–‡ä»¶/æ–‡ä»¶å¤¹`;
                        docStatusDiv.className = 'success';
                        
                        // å…ˆæ˜¾ç¤ºæ–‡ä»¶å¤¹ï¼Œå†æ˜¾ç¤ºæ–‡ä»¶
                        const folders = [];
                        const files = [];
                        
                        entries.forEach((entry) => {
                            if (entry.isDirectory) {
                                folders.push(entry);
                            } else {
                                files.push(entry);
                            }
                        });
                        
                        // æ˜¾ç¤ºæ–‡ä»¶å¤¹
                        folders.forEach((folderEntry) => {
                            const folderItem = document.createElement('div');
                            folderItem.className = 'file-item';
                            folderItem.style.backgroundColor = '#f5f5f5';
                            folderItem.style.cursor = 'pointer';
                            
                            folderItem.innerHTML = `
                                <div><strong>ğŸ“ æ–‡ä»¶å¤¹ï¼š</strong>${folderEntry.name}</div>
                            `;
                            
                            folderItem.addEventListener('click', () => {
                                pathHistory.push(currentPath);
                                currentPath = folderEntry.fullPath;
                                browseDocFolder(currentPath);
                            });
                            
                            docFileListDiv.appendChild(folderItem);
                        });
                        
                        // æ˜¾ç¤ºæ–‡ä»¶
                        files.forEach((fileEntry) => {
                            const fileItem = document.createElement('div');
                            fileItem.className = 'file-item';
                            
                            // æ ¹æ®æ–‡ä»¶ç±»å‹æ˜¾ç¤ºä¸åŒå›¾æ ‡
                            let fileIcon = 'ğŸ“„';
                            if (/\.(png|jpe?g|gif|webp)$/i.test(fileEntry.name)) {
                                fileIcon = 'ğŸ–¼ï¸';
                            } else if (/\.(txt|md)$/i.test(fileEntry.name)) {
                                fileIcon = 'ğŸ“';
                            } else if (/\.(html?|xml)$/i.test(fileEntry.name)) {
                                fileIcon = 'ğŸŒ';
                            } else if (/\.(pdf)$/i.test(fileEntry.name)) {
                                fileIcon = 'ğŸ“‘';
                            } else if (/\.(doc|docx)$/i.test(fileEntry.name)) {
                                fileIcon = 'ğŸ“˜';
                            } else if (/\.(xls|xlsx)$/i.test(fileEntry.name)) {
                                fileIcon = 'ğŸ“Š';
                            } else if (/\.(ppt|pptx)$/i.test(fileEntry.name)) {
                                fileIcon = 'ğŸ“½ï¸';
                            } else if (/\.(zip|rar|7z)$/i.test(fileEntry.name)) {
                                fileIcon = 'ğŸ—œï¸';
                            } else if (/\.(mp3|wav|ogg)$/i.test(fileEntry.name)) {
                                fileIcon = 'ğŸµ';
                            } else if (/\.(mp4|avi|mov)$/i.test(fileEntry.name)) {
                                fileIcon = 'ğŸ¬';
                            }
                            
                            fileItem.innerHTML = `
                                <div><strong>${fileIcon} æ–‡ä»¶ï¼š</strong>${fileEntry.name}</div>
                            `;
                            
                            // æ·»åŠ é¢„è§ˆæŒ‰é’®
                            const previewBtn = document.createElement('button');
                            previewBtn.textContent = 'é¢„è§ˆ';
                            previewBtn.style.marginTop = '5px';
                            previewBtn.addEventListener('click', () => {
                                previewFile(fileEntry);
                            });
                            fileItem.appendChild(previewBtn);
                            
                            docFileListDiv.appendChild(fileItem);
                        });
                    }, (error) => {
                        docStatusDiv.textContent = `è¯»å–æ–‡ä»¶å¤¹å¤±è´¥: ${error.message}`;
                        docStatusDiv.className = 'error';
                    });
                }, (error) => {
                    docStatusDiv.textContent = `æ‰¾ä¸åˆ°æ–‡ä»¶å¤¹: ${error.message}`;
                    docStatusDiv.className = 'error';
                });
            } catch (err) {
                docStatusDiv.textContent = `è®¿é—®æ–‡ä»¶å¤¹å‡ºé”™: ${err.message}`;
                docStatusDiv.className = 'error';
            }
        }
        
        // é¢„è§ˆæ–‡ä»¶
        function previewFile(fileEntry) {
            previewTitleDiv.textContent = fileEntry.name;
            previewContentDiv.innerHTML = '';
            filePreviewDiv.style.display = 'block';
            
            // æ ¹æ®æ–‡ä»¶ç±»å‹è¿›è¡Œä¸åŒçš„é¢„è§ˆå¤„ç†
            if (/\.(png|jpe?g|gif|webp)$/i.test(fileEntry.name)) {
                // å›¾ç‰‡é¢„è§ˆ
                const img = document.createElement('img');
                img.className = 'preview';
                img.src = fileEntry.toLocalURL();
                previewContentDiv.appendChild(img);
            } else if (/\.(txt|html?|css|js|json|xml|md)$/i.test(fileEntry.name)) {
                // æ–‡æœ¬æ–‡ä»¶é¢„è§ˆ
                fileEntry.file((file) => {
                    const reader = new plus.io.FileReader();
                    reader.onloadend = function(evt) {
                        const pre = document.createElement('pre');
                        pre.style.whiteSpace = 'pre-wrap';
                        pre.style.wordBreak = 'break-all';
                        pre.textContent = evt.target.result;
                        previewContentDiv.appendChild(pre);
                    };
                    reader.readAsText(file);
                });
            } else if (/\.(pdf)$/i.test(fileEntry.name)) {
                // PDFé¢„è§ˆï¼ˆä½¿ç”¨iframeï¼‰
                const iframe = document.createElement('iframe');
                iframe.style.width = '100%';
                iframe.style.height = '500px';
                iframe.src = fileEntry.toLocalURL();
                previewContentDiv.appendChild(iframe);
            } else if (/\.(mp3|wav|ogg)$/i.test(fileEntry.name)) {
                // éŸ³é¢‘é¢„è§ˆ
                const audio = document.createElement('audio');
                audio.controls = true;
                audio.style.width = '100%';
                audio.src = fileEntry.toLocalURL();
                previewContentDiv.appendChild(audio);
            } else if (/\.(mp4|webm)$/i.test(fileEntry.name)) {
                // è§†é¢‘é¢„è§ˆ
                const video = document.createElement('video');
                video.controls = true;
                video.style.width = '100%';
                video.style.maxHeight = '400px';
                video.src = fileEntry.toLocalURL();
                previewContentDiv.appendChild(video);
            } else {
                // å…¶ä»–æ–‡ä»¶ç±»å‹
                previewContentDiv.textContent = 'æ— æ³•é¢„è§ˆæ­¤ç±»å‹çš„æ–‡ä»¶';
                
                // æ·»åŠ æ‰“å¼€æŒ‰é’®
                const openBtn = document.createElement('button');
                openBtn.textContent = 'å°è¯•æ‰“å¼€æ–‡ä»¶';
                openBtn.style.marginTop = '10px';
                openBtn.addEventListener('click', () => {
                    plus.runtime.openFile(fileEntry.toLocalURL(), {}, function(e) {
                        previewContentDiv.innerHTML += '<p class="error">æ‰“å¼€æ–‡ä»¶å¤±è´¥</p>';
                    });
                });
                previewContentDiv.appendChild(openBtn);
            }
        }
    }
    </script>
</body>
</html>
